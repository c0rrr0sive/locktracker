<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LockTracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-top">
                <div class="header-logo">
                    <div>
                        <h1>LockTracker</h1>
                        <p class="subtitle">Track your bets. Know your edge.</p>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-email">{{ user.email }}</span>
                    {% if usage.tier == 'free' %}
                    <a href="{{ url_for('pricing') }}" class="btn-upgrade">Upgrade</a>
                    {% else %}
                    <span class="pro-badge">PRO</span>
                    {% endif %}
                    <a href="{{ url_for('settings') }}" class="btn-settings">Settings</a>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
                </div>
            </div>
        </header>

        <!-- Email Verification Banner -->
        {% if not email_confirmed %}
        <div class="email-banner">
            <span>Please verify your email address to secure your account.</span>
            <button class="resend-btn" id="resend-btn" onclick="resendVerification()">Resend Email</button>
        </div>
        {% endif %}

        <!-- Usage Banner -->
        {% if usage.tier == 'free' %}
        <div class="usage-banner {% if usage.at_limit %}at-limit{% elif usage.remaining <= 3 %}near-limit{% endif %}">
            <div class="usage-info">
                <span class="usage-count">{{ usage.monthly_count }}/{{ usage.monthly_limit }}</span>
                <span class="usage-label">bets synced this month</span>
            </div>
            {% if usage.at_limit %}
            <div class="usage-warning">
                <span>Monthly limit reached</span>
                <a href="{{ url_for('pricing') }}" class="btn-upgrade">Upgrade to Pro</a>
            </div>
            {% elif usage.remaining <= 3 %}
            <div class="usage-warning">
                <span>{{ usage.remaining }} bets remaining</span>
                <a href="{{ url_for('pricing') }}" class="btn-upgrade">Upgrade to Pro</a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Error Messages -->
        {% if error == 'limit_reached' %}
        <div class="error-banner">
            You've reached your monthly limit of {{ usage.monthly_limit }} bets.
            <a href="{{ url_for('pricing') }}" class="upgrade-link">Upgrade to Pro</a> for unlimited bets.
        </div>
        {% endif %}

        <!-- Stats Dashboard -->
        <section class="stats-dashboard">
            <div class="stat-card main-stat {{ 'positive' if stats.total_profit >= 0 else 'negative' }}">
                <span class="stat-label">Total Profit</span>
                <span class="stat-value">${{ "%.2f"|format(stats.total_profit) }}</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Win Rate</span>
                <span class="stat-value">{{ stats.win_rate }}%</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">ROI</span>
                <span class="stat-value">{{ stats.roi }}%</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Record</span>
                <span class="stat-value">{{ stats.wins }}-{{ stats.losses }}</span>
            </div>
        </section>

        <!-- Category Breakdown -->
        {% if category_stats.by_sport %}
        <section class="breakdown-section">
            <h2>By Sport</h2>
            <div class="breakdown-grid">
                {% for sport, data in category_stats.by_sport.items() %}
                <div class="breakdown-card {{ 'positive' if data.profit >= 0 else 'negative' }}">
                    <span class="breakdown-name">{{ sport }}</span>
                    <span class="breakdown-profit">${{ "%.2f"|format(data.profit) }}</span>
                    <span class="breakdown-record">{{ data.wins }}/{{ data.count }}</span>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if category_stats.by_bet_type %}
        <section class="breakdown-section">
            <h2>By Bet Type</h2>
            <div class="breakdown-grid">
                {% for bet_type, data in category_stats.by_bet_type.items() %}
                <div class="breakdown-card {{ 'positive' if data.profit >= 0 else 'negative' }}">
                    <span class="breakdown-name">{{ bet_type }}</span>
                    <span class="breakdown-profit">${{ "%.2f"|format(data.profit) }}</span>
                    <span class="breakdown-record">{{ data.wins }}/{{ data.count }}</span>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Analytics Section -->
        <section class="analytics-section">
            <div class="analytics-header">
                <h2>Analytics</h2>
                <div class="date-filters">
                    <button class="filter-btn" data-days="7">7D</button>
                    <button class="filter-btn active" data-days="30">30D</button>
                    <button class="filter-btn" data-days="90">90D</button>
                    <button class="filter-btn" data-days="">All</button>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card large">
                    <h3>Profit Over Time</h3>
                    <canvas id="profitChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Daily Profit/Loss</h3>
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Profit by Sport</h3>
                    <canvas id="sportChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Profit by Bet Type</h3>
                    <canvas id="betTypeChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Add New Bet Form -->
        <section class="add-bet-section">
            <h2>Log New Bet</h2>
            <form action="/add" method="POST" class="bet-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="sport">Sport</label>
                        <select id="sport" name="sport" required>
                            <option value="">Select...</option>
                            <option value="NBA">NBA</option>
                            <option value="NFL">NFL</option>
                            <option value="MLB">MLB</option>
                            <option value="NHL">NHL</option>
                            <option value="NCAAB">NCAAB</option>
                            <option value="NCAAF">NCAAF</option>
                            <option value="Soccer">Soccer</option>
                            <option value="UFC">UFC</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bet_type">Bet Type</label>
                        <select id="bet_type" name="bet_type" required>
                            <option value="">Select...</option>
                            <option value="Spread">Spread</option>
                            <option value="Moneyline">Moneyline</option>
                            <option value="Total">Total (O/U)</option>
                            <option value="Player Prop">Player Prop</option>
                            <option value="Game Prop">Game Prop</option>
                            <option value="Parlay">Parlay</option>
                            <option value="Teaser">Teaser</option>
                            <option value="Futures">Futures</option>
                            <option value="Live Bet">Live Bet</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="matchup">Matchup</label>
                        <input type="text" id="matchup" name="matchup" placeholder="e.g. Lakers vs Celtics" required>
                    </div>
                    <div class="form-group">
                        <label for="bet_description">Your Bet</label>
                        <input type="text" id="bet_description" name="bet_description" placeholder="e.g. Lakers -3.5" required>
                    </div>
                    <div class="form-group">
                        <label for="sportsbook">Sportsbook</label>
                        <select id="sportsbook" name="sportsbook">
                            <option value="">Select...</option>
                            <option value="DraftKings">DraftKings</option>
                            <option value="FanDuel">FanDuel</option>
                            <option value="PrizePicks">PrizePicks</option>
                            <option value="BetMGM">BetMGM</option>
                            <option value="Caesars">Caesars</option>
                            <option value="PointsBet">PointsBet</option>
                            <option value="BetRivers">BetRivers</option>
                            <option value="Bovada">Bovada</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="odds">Odds</label>
                        <input type="number" id="odds" name="odds" placeholder="-110" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Wager ($)</label>
                        <input type="number" id="amount" name="amount" step="0.01" placeholder="25.00" required>
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary">Log Bet</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Pending Bets -->
        {% if pending_bets %}
        <section class="bets-section">
            <h2>Pending Bets</h2>
            <div class="bets-list">
                {% for bet in pending_bets %}
                <div class="bet-card pending">
                    <div class="bet-info">
                        <span class="bet-sport">{{ bet.sport }}</span>
                        <span class="bet-matchup">{{ bet.matchup }}</span>
                        <span class="bet-description">{{ bet.bet_description }}</span>
                        <span class="bet-details">{{ bet.odds }} · ${{ "%.2f"|format(bet.amount) }}</span>
                    </div>
                    <div class="bet-actions">
                        <form action="/update/{{ bet.id }}" method="POST" class="inline-form">
                            <input type="hidden" name="result" value="win">
                            <button type="submit" class="btn btn-win">Win</button>
                        </form>
                        <form action="/update/{{ bet.id }}" method="POST" class="inline-form">
                            <input type="hidden" name="result" value="loss">
                            <button type="submit" class="btn btn-loss">Loss</button>
                        </form>
                        <form action="/update/{{ bet.id }}" method="POST" class="inline-form">
                            <input type="hidden" name="result" value="push">
                            <button type="submit" class="btn btn-push">Push</button>
                        </form>
                        <a href="{{ url_for('edit_bet', bet_id=bet.id) }}" class="btn btn-edit">Edit</a>
                        <form action="/delete/{{ bet.id }}" method="POST" class="inline-form">
                            <button type="submit" class="btn btn-delete">×</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Bet History -->
        <section class="bets-section">
            <div class="bets-header">
                <h2>Bet History</h2>
                <div class="bet-filters">
                    <select id="filter-sport" class="filter-select">
                        <option value="">All Sports</option>
                        <option value="NBA">NBA</option>
                        <option value="NFL">NFL</option>
                        <option value="MLB">MLB</option>
                        <option value="NHL">NHL</option>
                        <option value="NCAAB">NCAAB</option>
                        <option value="NCAAF">NCAAF</option>
                        <option value="Soccer">Soccer</option>
                        <option value="UFC">UFC</option>
                    </select>
                    <select id="filter-result" class="filter-select">
                        <option value="">All Results</option>
                        <option value="win">Wins</option>
                        <option value="loss">Losses</option>
                        <option value="push">Pushes</option>
                    </select>
                    <select id="filter-sportsbook" class="filter-select">
                        <option value="">All Sportsbooks</option>
                        <option value="FanDuel">FanDuel</option>
                        <option value="DraftKings">DraftKings</option>
                        <option value="PrizePicks">PrizePicks</option>
                        <option value="BetMGM">BetMGM</option>
                        <option value="Caesars">Caesars</option>
                    </select>
                </div>
            </div>
            {% if bets %}
            <div class="bets-list" id="bets-list">
                {% for bet in bets %}
                {% if bet.result != 'pending' %}
                <div class="bet-card {{ bet.result }}" data-sport="{{ bet.sport }}" data-result="{{ bet.result }}" data-sportsbook="{{ bet.sportsbook }}">
                    <div class="bet-info">
                        <span class="bet-sport">{{ bet.sport }}</span>
                        <span class="bet-matchup">{{ bet.matchup }}</span>
                        <span class="bet-description">{{ bet.bet_description }}</span>
                        <span class="bet-details">{{ bet.odds }} · ${{ "%.2f"|format(bet.amount) }}{% if bet.sportsbook %} · {{ bet.sportsbook }}{% endif %}</span>
                    </div>
                    <div class="bet-result">
                        <span class="result-badge {{ bet.result }}">{{ bet.result }}</span>
                        <span class="profit {{ 'positive' if bet.profit >= 0 else 'negative' }}">
                            {{ '+' if bet.profit >= 0 else '' }}${{ "%.2f"|format(bet.profit) }}
                        </span>
                    </div>
                    <div class="bet-card-actions">
                        <a href="{{ url_for('edit_bet', bet_id=bet.id) }}" class="btn btn-edit">Edit</a>
                        <form action="/delete/{{ bet.id }}" method="POST" class="inline-form">
                            <button type="submit" class="btn btn-delete">×</button>
                        </form>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="bets-list">
                <p class="no-bets">No bets logged yet. Add your first bet above!</p>
            </div>
            {% endif %}
        </section>

        <!-- Footer -->
        <footer>
            <a href="{{ url_for('landing') }}">View Landing Page</a> · <a href="{{ url_for('terms') }}">Terms of Service</a> · <a href="{{ url_for('privacy') }}">Privacy Policy</a>
        </footer>
    </div>

    <script>
    // Resend Verification Email
    async function resendVerification() {
        const btn = document.getElementById('resend-btn');
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            const response = await fetch('/resend-verification', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                btn.textContent = 'Sent!';
                btn.style.background = 'rgba(16, 185, 129, 0.2)';
                btn.style.color = '#10b981';
            } else {
                btn.textContent = 'Failed';
                setTimeout(() => {
                    btn.textContent = 'Resend Email';
                    btn.disabled = false;
                }, 2000);
            }
        } catch (error) {
            btn.textContent = 'Error';
            setTimeout(() => {
                btn.textContent = 'Resend Email';
                btn.disabled = false;
            }, 2000);
        }
    }
    </script>

    <script>
    // Bet History Filters
    document.addEventListener('DOMContentLoaded', function() {
        const filterSport = document.getElementById('filter-sport');
        const filterResult = document.getElementById('filter-result');
        const filterSportsbook = document.getElementById('filter-sportsbook');
        const betsList = document.getElementById('bets-list');

        function applyFilters() {
            if (!betsList) return;

            const sport = filterSport.value;
            const result = filterResult.value;
            const sportsbook = filterSportsbook.value;

            const cards = betsList.querySelectorAll('.bet-card');
            cards.forEach(card => {
                const cardSport = card.dataset.sport;
                const cardResult = card.dataset.result;
                const cardSportsbook = card.dataset.sportsbook || '';

                const matchSport = !sport || cardSport === sport;
                const matchResult = !result || cardResult === result;
                const matchSportsbook = !sportsbook || cardSportsbook === sportsbook;

                card.style.display = (matchSport && matchResult && matchSportsbook) ? '' : 'none';
            });
        }

        if (filterSport) filterSport.addEventListener('change', applyFilters);
        if (filterResult) filterResult.addEventListener('change', applyFilters);
        if (filterSportsbook) filterSportsbook.addEventListener('change', applyFilters);
    });
    </script>

    <script>
    // Chart.js Analytics
    document.addEventListener('DOMContentLoaded', function() {
        // Theme colors
        const colors = {
            positive: '#10b981',
            negative: '#f43f5e',
            accent: '#0ea5e9',
            text: '#9898a8',
            grid: 'rgba(255, 255, 255, 0.08)'
        };

        // Chart instances
        let profitChart, dailyChart, sportChart, betTypeChart;

        // Default Chart.js settings
        Chart.defaults.color = colors.text;
        Chart.defaults.borderColor = colors.grid;
        Chart.defaults.font.family = "'Inter', sans-serif";

        // Fetch and render charts
        async function loadCharts(days = 30) {
            const url = days ? `/api/analytics?days=${days}` : '/api/analytics';

            try {
                const response = await fetch(url);
                const data = await response.json();
                renderCharts(data);
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function renderCharts(data) {
            // Destroy existing charts
            if (profitChart) profitChart.destroy();
            if (dailyChart) dailyChart.destroy();
            if (sportChart) sportChart.destroy();
            if (betTypeChart) betTypeChart.destroy();

            // 1. Profit Over Time (Line Chart)
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            const gradient = profitCtx.createLinearGradient(0, 0, 0, 300);
            const lastValue = data.cumulative_profit[data.cumulative_profit.length - 1] || 0;
            const lineColor = lastValue >= 0 ? colors.positive : colors.negative;
            gradient.addColorStop(0, lastValue >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(244, 63, 94, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Cumulative Profit',
                        data: data.cumulative_profit,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.3,
                        pointRadius: data.dates.length > 30 ? 0 : 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            grid: { color: colors.grid },
                            ticks: { callback: (v) => '$' + v }
                        }
                    }
                }
            });

            // 2. Daily Profit/Loss (Bar Chart)
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            const barColors = data.daily_profit.map(v => v >= 0 ? colors.positive : colors.negative);

            dailyChart = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: 'Daily P/L',
                        data: data.daily_profit,
                        backgroundColor: barColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            grid: { color: colors.grid },
                            ticks: { callback: (v) => '$' + v }
                        }
                    }
                }
            });

            // 3. Profit by Sport (Horizontal Bar)
            const sportCtx = document.getElementById('sportChart').getContext('2d');
            const sportLabels = Object.keys(data.by_sport);
            const sportProfits = sportLabels.map(s => data.by_sport[s].profit);
            const sportColors = sportProfits.map(v => v >= 0 ? colors.positive : colors.negative);

            sportChart = new Chart(sportCtx, {
                type: 'bar',
                data: {
                    labels: sportLabels,
                    datasets: [{
                        label: 'Profit',
                        data: sportProfits,
                        backgroundColor: sportColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.x.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: colors.grid },
                            ticks: { callback: (v) => '$' + v }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });

            // 4. Profit by Bet Type (Horizontal Bar)
            const betTypeCtx = document.getElementById('betTypeChart').getContext('2d');
            const betTypeLabels = Object.keys(data.by_bet_type);
            const betTypeProfits = betTypeLabels.map(t => data.by_bet_type[t].profit);
            const betTypeColors = betTypeProfits.map(v => v >= 0 ? colors.positive : colors.negative);

            betTypeChart = new Chart(betTypeCtx, {
                type: 'bar',
                data: {
                    labels: betTypeLabels,
                    datasets: [{
                        label: 'Profit',
                        data: betTypeProfits,
                        backgroundColor: betTypeColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `$${ctx.parsed.x.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: colors.grid },
                            ticks: { callback: (v) => '$' + v }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // Date filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const days = this.dataset.days;
                loadCharts(days ? parseInt(days) : null);
            });
        });

        // Initial load
        loadCharts(30);
    });
    </script>
</body>
</html>
